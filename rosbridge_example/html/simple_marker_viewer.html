<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Simple Marker Viewer</title>
</head>
<body onload="init_ros_subprocess()">
	<h1>Simple marker viewer</h1>
	<div id="markers"></div><!-- Id needs to match id used by ROS3D.Viewer below.  Also it must be created before the viewer -->
</body>
<div id="subprocess-data" data-args="roslaunch rosbridge_example publish_marker.launch"></div>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/threejs/current/three.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/ros3djs/current/ros3d.min.js"></script>
<script type="text/javascript" type="text/javascript">
	function init_ros_subprocess()
	{
		// Connecting to ROS
		// -----------------
		var ros = new ROSLIB.Ros({url : 'ws://ubuntu.wireless.dyn.datasys.swri.edu:9090'});
		
		// subprocess publisher		
		var subproc_args_pub = new ROSLIB.Topic(
		{
			ros : ros,
			name : '/subprocess_arguments',
			messageType: 'std_msgs/String'
		});
		
		// subprocess state subscriber
		var subproc_running = false;
		var subproc_st_subs = new ROSLIB.Topic(
		{
			ros : ros,
			name : '/subprocess_status',
			messageType : 'std_msgs/Bool'
		});
				
	 	// subscribing to status topic
		subproc_st_subs.subscribe(function(bool_msg)
		{
			subproc_running = bool_msg.data
			
			// run demo
			if (subproc_running == true)
			{
				subproc_st_subs.unsubscribe();
				console.log("Subprocess running; starting demo");
				run_demo();
			}
		});	 	

	 	// publishing message
	 	subproc_args = $('#subprocess-data').data("args");
		console.log("subprocess arguments: " + subproc_args);		
		var subproc_args_msg = new ROSLIB.Message(
		{
			data : subproc_args
		});
	 	subproc_args_pub.publish(subproc_args_msg);
		
		function sleep(ms)
		{
			var dt = new Date();
			dt.setTime(dt.getTime() + ms);
			while (new Date().getTime() < dt.getTime());
		};
	}
</script>

<script type="text/javascript" type="text/javascript">
	function run_demo()
	{
		// Connect to ROS
		var ros = new ROSLIB.Ros({url : 'ws://ubuntu.wireless.dyn.datasys.swri.edu:9090'});
		
		// Create the main viewer
		var viewer = new ROS3D.Viewer({
			divID: 'markers',
			width: 800,
			height: 600,
			antialias : true		
		});
		
		// TF listner
		var tf_client = new ROSLIB.TFClient({
			ros:ros,
			angularThres : 0.01,
			transThres :0.01,
			rate : 10.0,
			fixedFrame : '/world_frame'		
		});
		
		
		// Add Grid	
		viewer.addObject(new ROS3D.Grid({
			size: 20,
			color : '#cccccc',
			lineWidth : 0.1		
		}))
		
		
		// Marker Client
		var marker_client = new ROS3D.MarkerClient({
			ros:ros,
			tfClient : tf_client,
			topic : '/marker_msg',
			rootObject : viewer.scene	
		});
		
		console.log('Viewer Ready');
	}	
</script>
</html>